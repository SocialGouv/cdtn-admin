hasura:
  imagePackage: hasura
  ~needs: [post-restore, build-hasura]
  ~preDeploy.cleaner:
    match:
      kind: Deployment
    value: true
  envFrom:
    - secretRef:
        name: pg-user
    - configMapRef:
        name: hasura
    - secretRef:
        name: hasura

jobs:
  runs:
    drop-db: # temp
      use: drop-db
    create-db:
      ~needs: [drop-db] # temp
      use: create-db
    restore:
      ~needs: [create-db]
      use: pg-restore
      checkout: false
      with:
        mountPath: /mnt/restore
        filterPath: "hasura_prod_db.psql.gz"
        restorePath: "${LATEST}"
      volumeMounts:
        - name: restore
          mountPath: /mnt/restore
          readOnly: true
      volumes:
        - name: restore
          csi:
            driver: file.csi.azure.com
            readOnly: true
            volumeAttributes:
              secretName: cdtnadminprodserver-backup-credentials
              shareName: cdtnadminprodserver-backup-restore
    post-restore:
      ~needs: [restore]
      use: psql
      with:
        sqlFile: .kontinuous/sql/post-restore.sql
    job-ingester:
      ~needs: [post-restore]
      image: ghcr.io/socialgouv/kontinuous:v1
      checkout: false
      kubernetes: true
      user: 1001
      run: |
        current_date=$(date +%s)
        kubectl create job --from=cronjob/cron-ingester ingester-manual-$current_date --namespace={{.Values.global.namespace}}
        rollout-status -kind=job -namespace={{.Values.global.namespace}} -selector=job-name=ingester-manual-$current_date
    job-alert:
      ~needs: [post-restore]
      image: ghcr.io/socialgouv/kontinuous:v1
      checkout: false
      kubernetes: true
      user: 1001
      run: |
        current_date=$(date +%s)
        kubectl create job --from=cronjob/cron-alert alert-manual-$current_date --namespace={{.Values.global.namespace}}
        rollout-status -kind=job -namespace={{.Values.global.namespace}} -selector=job-name=alert-manual-$current_date