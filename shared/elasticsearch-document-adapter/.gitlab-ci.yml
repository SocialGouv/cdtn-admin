#
#
#

ðŸ“¦ elasticsearch-document-adapter:
  extends:
    - .autodevops_install
    - .cdtn_base_rules
  image: node:14.16.0-alpine3.11
  needs:
    - job: ðŸ“¦ logger
      artifacts: true
  cache:
    key: ${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}
    paths:
      - .cache
  variables:
    CACHE_COMPRESSION_LEVEL: fastest
    # CACHE_FALLBACK_KEY: ${CI_JOB_NAME}-${CI_DEFAULT_BRANCH}
    CACHE_FALLBACK_KEY: ${CI_JOB_NAME}-alpha
    FF_USE_FASTZIP: "true"
  script:
    - yarn config set cache-folder ${CI_PROJECT_DIR}/.cache/yarn
    - yarn global add @socialgouv/yarn-workspace-focus-install
    - yarn exec yarn-workspace-focus-install
      --
      --cwd shared/elasticsearch-document-adapter
      --
      --frozen-lockfile --prefer-offline
    #
    # NOTE(douglasduteil): group a pipeline in one job
    # To avoid a lenghy pipeline we do all the tasks here...
    #
    - cd shared/elasticsearch-document-adapter
    #
    #
    #
    - yarn lint
    - yarn test
    - yarn build
  artifacts:
    expire_in: 1 week
    paths:
      - shared/elasticsearch-document-adapter/lib
