# Extract from https://github.com/SocialGouv/gitlab-ci-yml/blob/v20.7.14/base_autodevops.yml#L326-L347
Stop review:
  image: ghcr.io/socialgouv/docker/no-k8s:6.43.2
  cache:
    key:
      files:
        - .k8s/yarn.lock
      prefix: ${CI_JOB_NAME}
    paths:
      - .cache
  variables:
    GIT_STRATEGY: none
  environment:
    name: ${CI_COMMIT_REF_NAME}${AUTO_DEVOPS_DEV_ENVIRONMENT_NAME}
  script:
    - yarn global add degit
    - rm -rf .k8s
    - yarn exec degit "SocialGouv/kosko-charts/templates/autodevops#v9.3.0" .k8s
    - yarn --cwd .k8s --production --frozen-lockfile --prefer-offline --link-duplicates
    - yarn --silent --cwd .k8s kosko generate --env dev jobs/drop-db > ${CI_PROJECT_DIR}/manifest.yaml
    - kubectl --namespace ${KUBE_NAMESPACE} apply -f ${CI_PROJECT_DIR}/manifest.yaml || true

    - timeout 15m
      bash -c "
      until
      kubectl get pod -l job-name="drop-azure-db-${CI_COMMIT_SHORT_SHA}"
      -o jsonpath='{.items[0].status.conditions[?(@.type==\"ContainersReady\")].status}' |
      grep True
      ; do sleep 1; done"

    - kubectl logs -f job/drop-azure-db-${CI_COMMIT_SHORT_SHA}
    - kubectl delete namespace "${KUBE_NAMESPACE}"
  artifacts:
    expire_in: 1 week
    paths:
      - manifest.yaml
    when: always
