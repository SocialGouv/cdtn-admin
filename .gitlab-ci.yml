include:
  - project: SocialGouv/gitlab-ci-yml
    file: /autodevops_simple_app.yml
    ref: v16.2.0
  - project: SocialGouv/gitlab-ci-yml
    file: /base_deploy_kosko_stage.yml
    ref: v20.6.1
  #
  - /targets/alert-cli/.gitlab-ci.yml
  - /targets/ingester/.gitlab-ci.yml
  - /targets/hasura/.gitlab-ci.yml
  - /targets/frontend/.gitlab-ci.yml

workflow:
  rules:
    # Skip GitHub pull requests pipelines
    - if: $CI_PIPELINE_SOURCE == 'external_pull_request_event'
      when: never
    # Otherwise include the job and set to run normally
    - when: always

variables:
  ENABLE_AZURE_POSTGRES: 1

K8S Test:
  needs: []
  rules:
    -  if: "$PRODUCTION || $RELEASE"
      when: never
    - exists:
        - .k8s/package.json
  extends:
    - .base_kosko_k8s_test

Create namespace:
  extends:
    - .autodevops_create_namespace
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2
  after_script:
    # Copy namespace default creds
    - kubectl get secret cdtn-admin-secrets --namespace=cdtn-admin-secret --export -o yaml |
      kubectl apply --namespace=${K8S_NAMESPACE} -f -
    - kubectl get secret azure-cdtnadmindev-volume --namespace=cdtn-admin-secret --export -o yaml |
      kubectl apply --namespace=${K8S_NAMESPACE} -f -

Create Azure DB (dev):
  extends: .autodevops_create_azure_db_dev
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2
  variables:
    NEW_DB_EXTENSIONS: "pgcrypto hstore citext"

Drop Azure DB (dev):
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2
#

Stop review:
  extends: .autodevops_stop_review
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2

Notify Success (prod):
  extends: .autodevops_notify_success_prod
  environment:
    name: ${CI_COMMIT_REF_SLUG}-prod2

Notify Fail (prod):
  extends: .autodevops_notify_fail_prod
  environment:
    name: ${CI_COMMIT_REF_SLUG}-prod2

Notify Success (review):
  extends: .autodevops_notify_success_review
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2

Notify Fail (review):
  extends: .autodevops_notify_fail_review
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2

#

Install:
  only:
    - never

Build:
  needs: []
  only:
    - never
Test:
  needs: []
  only:
    - never
Lint:
  needs: []
  only:
    - never

Register image:
  only:
    - never

Deploy app (dev):
  only:
    - never
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2

Deploy app (prod):
  only:
    - never

Release:
  variables:
    SEMANTIC_RELEASE_PLUGINS: "
      @semantic-release/changelog
      @semantic-release/exec
      @semantic-release/git
    "
  before_script:
    - yarn global add lerna

#

# todo: restrict to branches ?
Restore data:
  stage: Deploy
  only:
    - branches
  except:
    - master
    - tags
  extends:
    - .base_deploy_kosko_stage
  environment:
    name: prod2
  needs:
    - job: Create Azure DB (dev)
  dependencies: null
  variables:
    # storage copy
    SOURCE_CONTAINER: "cdtn"
    SOURCE_SERVER: "dev"
    DESTINATION_CONTAINER: "cdtn-dev"
    DESTINATION_SERVER: "dev"
    # db restore
    BACKUP_DB_NAME: "db_${CI_COMMIT_SHORT_SHA}"
    BACKUP_DB_OWNER: "user_${CI_COMMIT_SHORT_SHA}"
    BACKUP_DB_FILE: "hasura_prod_db.psql.gz"
    # kosko options
    KOSKO_GENERATE_ARGS: --env prod jobs/restore

Generate sitemap (prod):
  stage: Install
  needs: []
  extends:
    - .base_deploy_kosko_stage
  rules:
    - if: '($CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "web") && $ACTION == "SITEMAP"'
      when: always
    - if: '($CI_COMMIT_TAG || $CI_COMMIT_REF_SLUG == "master")'
      when: manual
      allow_failure: true
    - when: never
  environment:
    name: prod2
  variables:
    SITEMAP_ENDPOINT: "https://cdtn-admin.fabrique.social.gouv.fr/api/sitemap"
    DESTINATION_CONTAINER: sitemap
    DESTINATION_NAME: sitemap.xml
    SECRET_NAME: azure-cdtnadminprod-volume
    KOSKO_GENERATE_ARGS: --env prod jobs/sitemap-uploader

Generate sitemap (dev):
  stage: Install
  needs: []
  extends:
    - .base_deploy_kosko_stage
  rules:
    - if: '($CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "web") && $ACTION == "SITEMAP"'
      when: always
    - if: '($CI_COMMIT_TAG == "" || $CI_COMMIT_REF_SLUG != "master")'
      when: manual
      allow_failure: true
    - when: never
  environment:
    name: prod2
  variables:
    SITEMAP_ENDPOINT: "https://cdtn-admin.fabrique.social.gouv.fr/api/sitemap"
    DESTINATION_CONTAINER: sitemap
    DESTINATION_NAME: sitemap.xml
    SECRET_NAME: azure-cdtnadmindev-volume
    KOSKO_GENERATE_ARGS: --env dev jobs/sitemap-uploader
