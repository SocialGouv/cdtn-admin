include:
  - project: SocialGouv/gitlab-ci-yml
    file: /base_autodevops.yml
    ref: v20.7.14
  #
  - /shared/logger/.gitlab-ci.yml
  - /shared/elasticsearch-document-adapter/.gitlab-ci.yml
  #
  - /targets/alert-cli/.gitlab-ci.yml
  - /targets/ingester/.gitlab-ci.yml
  - /targets/hasura/.gitlab-ci.yml
  - /targets/frontend/.gitlab-ci.yml
  - /targets/ingester-elasticsearch/.gitlab-ci.yml


#
#
#

variables:
  AUTO_DEVOPS_ENABLE_KAPP: "🕹️"

#
#
#

.cdtn_base_rules:
  interruptible: true
  needs: []
  interruptible: true
  rules:
    - if: $PRODUCTION || $RELEASE
      when: never
    - if: $UPDATE_ES_INDEX
      when: never
    - if: $CI_COMMIT_MESSAGE =~ /^chore(release):*/
      when: never
    - when: on_success

#
#
#

🛂 k8s test:
  extends:
    - .base_kosko_k8s_test
    - .cdtn_base_rules
  stage: .pre

# Extract from https://github.com/SocialGouv/gitlab-ci-yml/blob/v20.7.14/base_autodevops.yml#L326-L347
Stop review:
  extends:
    - .autodevops_stop_review
  image: registry.gitlab.factory.social.gouv.fr/socialgouv/docker/no-k8s:5.0.1
  cache:
    key:
      files:
        - .k8s/yarn.lock
      prefix: k8s
    paths:
      - .cache
      - .k8s/node_modules
  variables:
    GIT_STRATEGY: none
  script:
    - yarn config set cache-folder ${CI_PROJECT_DIR}/.cache/yarn
    - yarn global add degit
    - yarn exec degit "SocialGouv/kosko-charts/templates/autodevops#v5.2.0-alpha.5" .k8s
    - yarn --cwd .k8s --production --frozen-lockfile --prefer-offline --link-duplicates
    - yarn --silent --cwd .k8s dropdb > ${CI_PROJECT_DIR}/manifest.yaml
    - kapp -y deploy -a ${CI_PROJECT_NAME} --namespace ${KUBE_NAMESPACE} -f ${CI_PROJECT_DIR}/manifest.yaml
    - kapp -y delete -a ${CI_PROJECT_NAME} --namespace ${KUBE_NAMESPACE}
    - kubectl delete namespace "${KUBE_NAMESPACE}" || true
  artifacts:
    expire_in: 1 week
    paths:
      - manifest.yaml
    when: always

#
#
#

Release:
  extends:
    - .autodevops_release
  variables:
    SEMANTIC_RELEASE_PLUGINS: |-
      @semantic-release/changelog
      @semantic-release/exec
      @semantic-release/git
  before_script:
    - npm config set access public
    - npm config set //registry.npmjs.org/:_authToken ${NPM_TOKEN}
    # Use github as origin
    # see https://github.com/SocialGouv/gitlab-ci-yml/blob/v20.7.14/base_semantic_release_stage.yml#L20-L22
    - git remote set-url origin https://${GITHUB_TOKEN}@github.com/${CI_PROJECT_PATH}.git

    - yarn global add lerna


#
#
#

.generate_sitemap:
  extends:
    - .base_deploy_kosko_stage
    - .cdtn_base_rules
  stage: Install
  environment:
    name: prod2

🚩 Generate sitemap (review):
  extends:
    - .generate_sitemap
  rules:
    - if: '($CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "web") && $ACTION == "SITEMAP"'
      when: always
    - if: '($CI_COMMIT_TAG == "" || $CI_COMMIT_REF_SLUG != "master")'
      when: manual
      allow_failure: true
    - when: never
  variables:
    SITEMAP_ENDPOINT: "https://cdtn-admin.fabrique.social.gouv.fr/api/sitemap"
    DESTINATION_CONTAINER: sitemap
    DESTINATION_NAME: sitemap.xml
    SECRET_NAME: azure-cdtnadmindev-volume
    KOSKO_GENERATE_ARGS: --env dev jobs/sitemap-uploader

🚩 Generate sitemap (prod):
  extends:
    - .generate_sitemap
  rules:
    - if: '($CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "web") && $ACTION == "SITEMAP"'
      when: always
    - if: '$CI_COMMIT_TAG && $PRODUCTION'
      when: manual
      allow_failure: true
    - when: never
  variables:
    SITEMAP_ENDPOINT: "https://cdtn-admin.fabrique.social.gouv.fr/api/sitemap"
    DESTINATION_CONTAINER: sitemap
    DESTINATION_NAME: sitemap.xml
    SECRET_NAME: azure-cdtnadminprod-volume
    KOSKO_GENERATE_ARGS: --env prod jobs/sitemap-uploader
