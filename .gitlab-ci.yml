include:
  - project: SocialGouv/gitlab-ci-yml
    file: /autodevops_simple_app.yml
    ref: v16.2.0
  - project: SocialGouv/gitlab-ci-yml
    file: /base_deploy_kosko_stage.yml
    ref: v20.1.1
  #
  - /targets/alert-cli/.gitlab-ci.yml
  - /targets/ingester/.gitlab-ci.yml
  - /targets/hasura/.gitlab-ci.yml
  - /targets/frontend/.gitlab-ci.yml

workflow:
  rules:
    # Skip GitHub pull requests pipelines
    - if: $CI_PIPELINE_SOURCE == 'external_pull_request_event'
      when: never
    # Otherwise include the job and set to run normally
    - when: always

variables:
  ENABLE_AZURE_POSTGRES: 1

Create namespace:
  extends:
    - .autodevops_create_namespace
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2
  after_script:
    # Copy namespace default creds
    - kubectl get secret cdtn-admin-secrets --namespace=cdtn-admin-secret --export -o yaml |
      kubectl apply --namespace=${K8S_NAMESPACE} -f -

Create Azure DB (dev):
  extends: .autodevops_create_azure_db_dev
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2
  variables:
    NEW_DB_EXTENSIONS: "pgcrypto hstore citext"

Drop Azure DB (dev):
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2
#

Stop review:
  extends: .autodevops_stop_review
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2

Notify Success (prod):
  extends: .autodevops_notify_success_prod
  environment:
    name: ${CI_COMMIT_REF_SLUG}-prod2

Notify Fail (prod):
  extends: .autodevops_notify_fail_prod
  environment:
    name: ${CI_COMMIT_REF_SLUG}-prod2

Notify Success (review):
  extends: .autodevops_notify_success_review
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2

Notify Fail (review):
  extends: .autodevops_notify_fail_review
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2

#

Install:
  only:
    - never

Build:
  needs: []
  only:
    - never
Test:
  needs: []
  only:
    - never
Lint:
  needs: []
  only:
    - never

Register image:
  only:
    - never

Deploy app (dev):
  only:
    - never
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2

Deploy app (prod):
  only:
    - never

#

Restore container:
  stage: .post
  when: manual
  extends:
    - .base_deploy_kosko_stage
  environment:
    name: prod2
  variables:
    # storage copy
    SOURCE_CONTAINER: "prod-container"
    DESTINATION_CONTAINER: "dev-container"
    # db restore
    BACKUP_DB_NAME: "db_${CI_COMMIR_SHORT_SHA}"
    BACKUP_DB_OWNER: "user_${CI_COMMIR_SHORT_SHA}"
    BACKUP_DB_FILE: "hasura_prod_db.psql.gz"
    # kosko options
    KOSKO_GENERATE_ARGS: --env dev restore
