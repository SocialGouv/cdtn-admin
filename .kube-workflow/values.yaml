app-www:
  probesPath: /healthz
  imagePackage: cdtn-admin-frontend
  envFrom:
    - configMapRef:
        name: www
    - secretRef:
        name: www
  env:
    - name: "FRONTEND_HOST"
      value: "{{.Values.global.host}}"
  ingress:
    annotations:
      "nginx.ingress.kubernetes.io/whitelist-source-range": "123.456.456.789,42.0.0.0/8"
  resources:
    limits:
      cpu: "1000m"
      memory: "560Mi"
    requests:
      cpu: "5m"
      memory: "128Mi"

app-export:
  ingress:
    enabled: false
  imagePackage: "cdtn-admin-export-elasticsearch"
  envFrom:
    - configMapRef:
        name: "export-elasticsearch"
    - secretRef:
        name: "export-elasticsearch"

hasura:
  needs: [seed]
  imagePackage: cdtn-admin-hasura
  envFrom:
    - configMapRef:
        name: hasura
    - secretRef:
        name: hasura

jobs:
  runs:
    restore:
      use: SocialGouv/kube-workflow/jobs/restore-db
      with:
       restorePath: /mnt/restore/hasura_prod_db.psql.gz
      volumeMounts:
        - name: restore
          mountPath: /mnt/restore
          readOnly: true
      volumes:
        - name: restore
          persistantVolumeClaim:
            claimName: cdtn-admin-backup-restore
    seed:
      needs: [restore]
      use: SocialGouv/kube-workflow/jobs/seed-db
      with:
        seedPath: /workspace/.kube-workflow/sql/post-restore.sql
