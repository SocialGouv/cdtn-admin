âš“ ingester-elasticsearch:
  extends:
    - .autodevops_install
    - .cdtn_base_rules
  image: node:14.16.0-alpine3.11
  cache:
    key: ${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}
    paths:
      - .cache
  variables:
    CACHE_COMPRESSION_LEVEL: fastest
    CACHE_FALLBACK_KEY: ${CI_JOB_NAME}-${CI_DEFAULT_BRANCH}
    FF_USE_FASTZIP: "true"
  script:
    - yarn config set cache-folder ${CI_PROJECT_DIR}/.cache/yarn
    - yarn global add @socialgouv/yarn-workspace-focus-install
    - yarn exec yarn-workspace-focus-install
      --
      --cwd targets/ingester-elasticsearch
      --
      --frozen-lockfile --prefer-offline
  artifacts:
    expire_in: 1 week
    paths:
      - targets/ingester-elasticsearch/node_modules
      - node_modules

#
#
#

ðŸ§ª ingester-elasticsearch:
  extends:
    - .autodevops_test
    - .cdtn_base_rules
  needs:
    - job: âš“ ingester-elasticsearch
      artifacts: true
  before_script:
    - cd targets/ingester-elasticsearch

ðŸ§» ingester-elasticsearch:
  extends:
    - .autodevops_lint
    - .cdtn_base_rules
  needs:
    - job: âš“ ingester-elasticsearch
      artifacts: true
  before_script:
    - cd targets/ingester-elasticsearch
  script:
    - yarn types
    - yarn lint

#
#
#

ðŸŽ¯ ingester-elasticsearch:
  extends:
    - .base_yarn_script
    - .cdtn_base_rules
  image: node:14.16.0-alpine3.11
  needs:
    - job: âš“ ingester-elasticsearch
      artifacts: true
    - job: ðŸ“¦ elasticsearch-document-adapter
      artifacts: true
    - job: ðŸ“¦ logger
      artifacts: true
  before_script:
    - cd targets/ingester-elasticsearch
  script:
    - yarn build
  artifacts:
    expire_in: 1 week
    paths:
      - targets/ingester-elasticsearch/bin

#
#
#

ðŸ—ƒ ingester-elasticsearch:
  extends:
    - .autodevops_register_image
    - .cdtn_base_rules
  needs:
    - job: ðŸŽ¯ ingester-elasticsearch
      artifacts: true
  variables:
    CONTEXT: targets/ingester-elasticsearch
    IMAGE_NAME: $CI_REGISTRY_IMAGE/ingester-elasticsearch

#
#
#

ðŸš€ ingester-elasticsearch (dev):
  extends:
    - .base_deploy_kosko_stage
  stage: Deploy
  rules:
    - if: '($CI_PIPELINE_SOURCE == "trigger" || $CI_PIPELINE_SOURCE == "web") && $ACTION == "ingest_documents_dev"'
      when: always
    - if: "$PRODUCTION || $RELEASE || $CI_COMMIT_TAG"
      when: never
    # - when: on_success
    - when: manual
      allow_failure: true
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2
  needs:
    - job: K8S Test
    - job: Register ingester-elasticsearch
  dependencies: null
  before_script:
    - kubectl config set-context --current --namespace=${KUBE_NAMESPACE}
    - kubectl delete job ingester-elasticsearch || true
  variables:
    # kosko options
    KOSKO_GENERATE_ARGS: --env dev jobs/ingester-elasticsearch
