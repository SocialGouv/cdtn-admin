#
#
#

Install www:
  extends: .autodevops_install
  image: node:12.18.0-alpine3.11
  cache:
    key:
      files:
        - yarn.lock
      prefix: ${CI_JOB_NAME}
    paths:
      - yarn
  script:
    - yarn config set cache-folder $CI_PROJECT_DIR/yarn
    - npx @socialgouv/yarn-workspace-focus-install --cwd targets/frontend
  artifacts:
    expire_in: 1 week
    paths:
      - "shared/*/node_modules"
      - targets/frontend/node_modules
      - node_modules

#
#
#

.build_www:
  extends: .autodevops_build
  cache:
    key: ${CI_COMMIT_REF_NAME}-${CI_JOB_NAME}
    paths:
      - targets/frontend/.next/cache
  dependencies: null
  needs:
    - job: Install www
      artifacts: true
  before_script:
    # - cp .env targets/frontend/.env.production
    - cd targets/frontend
    - echo "NEXT_PUBLIC_CONTAINER_NAME = ${AZ_CONTAINER_NAME}" >> .env
    - cat .env
  artifacts:
    expire_in: 1 week
    paths:
      - targets/frontend/.next
      - targets/frontend/.env

.env_dev_rules:
  except:
    refs:
      - tags
      - master
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2

.env_prod_rules:
  only:
    refs:
      - master
  environment:
    name: prod2

Build www (dev):
  extends:
    - .build_www
    - .env_dev_rules

Build www (prod):
  extends:
    - .build_www
    - .env_prod_rules

Test www:
  extends: .autodevops_test
  dependencies: null
  needs:
    - job: Install www
      artifacts: true
  before_script:
    - cd targets/frontend

Lint www:
  extends: .autodevops_lint
  dependencies: null
  needs:
    - job: Install www
      artifacts: true
  before_script:
    - cd targets/frontend

#
#
#

.register_www:
  extends: .autodevops_register_image
  dependencies: null
  variables:
    CONTEXT: .
    DOCKER_BUILD_ARGS: >-
      --shm-size 512M
      -f targets/frontend/Dockerfile
    IMAGE_NAME: $CI_REGISTRY_IMAGE/www

Register www (dev):
  extends:
    - .register_www
    - .env_dev_rules
  needs:
    - Build www (dev)
  dependencies:
    - Build www (dev)

Register www (prod):
  extends:
    - .register_www
    - .env_prod_rules
  needs:
    - Build www (prod)
  dependencies:
    - Build www (prod)

#
#
#

.deploy_www_stage:
  variables:
    PORT: 3000
    CONTEXT: www
    VALUES_FILE: targets/frontend/.k8s/www.values.yml
    HELM_RENDER_ARGS: >-
      --set ingress.annotations.nginx\.ingress\.kubernetes\.io\/whitelist-source-range=$IP_ALLOWLIST

  after_script:
    - find ${MANIFEST_FOLDER} -name '*.yaml' -exec
      echo '---' \; -exec cat {} \; |
      envsubst >> manifest.yaml
    - kubectl apply --namespace=${K8S_NAMESPACE} -f manifest.yaml

Deploy www (dev):
  extends:
    - .autodevops_deploy_app_dev
    - .deploy_www_stage
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2
  variables:
    MANIFEST_FOLDER: targets/frontend/.k8s/environments/dev

Deploy www (prod):
  extends:
    - .autodevops_deploy_app_prod
    - .deploy_www_stage
  environment:
    name: prod2
  variables:
    MANIFEST_FOLDER: targets/frontend/.k8s/environments/prod
