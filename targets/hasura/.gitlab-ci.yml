Register Hasura:
  extends: .autodevops_register_image
  dependencies: []
  needs: []
  variables:
    CONTEXT: ./targets/hasura
    IMAGE_NAME: $CI_REGISTRY_IMAGE/hasura

#
#
#

.deploy_hasura:
  needs:
    - job: Register Hasura
  variables:
    PORT: 80
    CONTEXT: hasura
    VALUES_FILE: ./targets/hasura/.k8s/hasura.values.yml

Deploy Hasura (dev):
  extends:
    - .autodevops_deploy_app_dev
    - .deploy_hasura
  needs:
    - job: Create Azure DB (dev)
  environment:
    name: ${CI_COMMIT_REF_SLUG}-dev2
  variables:
    PG_HOST: cdtnadmindevserver.postgres.database.azure.com
    HELM_RENDER_ARGS: >-
      --set deployment.env[9].name=HASURA_GRAPHQL_DATABASE_URL
      --set deployment.env[9].value=postgresql://user_${CI_COMMIT_SHORT_SHA}%40${PG_HOST}:pass_${CI_COMMIT_SHORT_SHA}@${PG_HOST}:5432/db_${CI_COMMIT_SHORT_SHA}?sslmode=require

Deploy Hasura (prod):
  extends:
    - .autodevops_deploy_app_prod
    - .deploy_hasura
  environment:
    name: prod2
  variables:
    PRODUCTION: "true"
