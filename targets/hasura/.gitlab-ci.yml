üóÉ hasura:
  extends:
    - .autodevops_register_image
    - .cdtn_base_rules
  variables:
    CONTEXT: ./targets/hasura
    IMAGE_NAME: $CI_REGISTRY_IMAGE/hasura

#
#
#

# todo: restrict to branches ?
‚è™ Restore data:
  extends:
    - .base_deploy_kosko_stage
    - .cdtn_base_rules
  stage: Deploy
  environment:
    name: prod2
  needs:
    - job: üõÇ k8s test
  variables:
    # storage copy
    SOURCE_CONTAINER: "cdtn"
    SOURCE_SERVER: "dev"
    DESTINATION_CONTAINER: "cdtn-dev"
    DESTINATION_SERVER: "dev"
    # db restore
    BACKUP_DB_NAME: "db_${CI_COMMIT_SHORT_SHA}"
    BACKUP_DB_OWNER: "user_${CI_COMMIT_SHORT_SHA}"
    BACKUP_DB_FILE: "hasura_prod_db.psql.gz"
    # kosko options
    KOSKO_GENERATE_ARGS: --env prod jobs/restore

#
#
#

üöß Cleanup db cronjob (prod):
  extends:
    - .base_deploy_kosko_stage
    - .cdtn_base_rules
  rules:
    - if: "$PRODUCTION && $CI_COMMIT_TAG"
      when: always
  environment:
    name: prod2
  variables:
    KOSKO_GENERATE_ARGS: --env prod jobs/cleanup-db
